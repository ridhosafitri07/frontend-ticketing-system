<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - EventKu</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="dashboard-body">
    
    <!-- Navbar - yeayy udah responsive nih! üíï -->
    <nav class="navbar">
        <div class="nav-container">
            <!-- Logo & nama app (kiri banget) -->
            <div class="nav-brand">
                <img src="images/logo tiket.jpg" alt="EventKu Logo" class="logo-img">
                <h2>EventKu</h2>
            </div>
            
            <!-- Hamburger menu buat mobile (biar kece) üçî -->
            <button class="hamburger-menu" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <!-- Menu navigasi (bakal slide down di mobile) -->
            <div class="nav-menu" id="navMenu">
                <a href="dashboard.html" class="nav-link active">
                    <img src="images/home icon.png" alt="Home" class="nav-icon"> Home
                </a>
                <a href="riwayat.html" class="nav-link">
                    <img src="images/riwayaticon.png" alt="Riwayat" class="nav-icon"> Riwayat
                </a>
                <a href="profile.html" class="nav-link">
                    <img src="images/profil icon.jpg" alt="Profil" class="nav-icon"> Profil
                </a>
            </div>
            
            <!-- User info & tombol logout (kanan banget) -->
            <div class="nav-user">
                <span id="userName">Loading...</span>
                <button class="btn-logout" onclick="handleLogout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- ========================================
             HEADER DASHBOARD
             ======================================== -->
        <div class="dashboard-header">
            <h1>Event & Konser Terbaru</h1>
            <p>Pilih event favorit kamu dan pesan tiketnya sekarang!</p>
        </div>

        <!-- ========================================
             FILTER & SEARCH SECTION
             Section untuk cari & filter event
             ======================================== -->
        <div class="filter-search-section">
            
            <!-- Search Bar -->
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Cari event berdasarkan nama..." 
                    onkeyup="applyFilters()">
            </div>

            <!-- Filter Controls -->
            <div class="filter-controls">
                
                <!-- Filter Kategori -->
                <div class="filter-group">
                    <label>üìÇ Kategori:</label>
                    <select id="filterCategory" onchange="applyFilters()">
                        <option value="all">Semua Kategori</option>
                        <option value="musik">üéµ Musik</option>
                        <option value="komedi">üòÇ Komedi</option>
                        <option value="seminar">üíª Seminar</option>
                        <option value="kuliner">üçú Kuliner</option>
                        <option value="teater">üé≠ Teater</option>
                         <option value="konser">üé∏ Konser</option>
                    </select>
                </div>

                <!-- Filter Harga -->
                <div class="filter-group">
                    <label>üí∞ Range Harga:</label>
                    <select id="filterPrice" onchange="applyFilters()">
                        <option value="all">Semua Harga</option>
                        <option value="0-100000">< Rp 100.000</option>
                        <option value="100000-300000">Rp 100.000 - 300.000</option>
                        <option value="300000-500000">Rp 300.000 - 500.000</option>
                        <option value="500000-999999999">> Rp 500.000</option>
                    </select>
                </div>

                <!-- Sort By -->
                <div class="filter-group">
                    <label>üîÑ Urutkan:</label>
                    <select id="sortBy" onchange="applyFilters()">
                        <option value="default">Default</option>
                        <option value="price-low">Harga Termurah</option>
                        <option value="price-high">Harga Termahal</option>
                        <option value="name-asc">Nama A-Z</option>
                        <option value="name-desc">Nama Z-A</option>
                    </select>
                </div>

                <!-- Reset Button -->
                <button class="btn-reset-filter" onclick="resetFilters()">
                    ‚Üª Reset Filter
                </button>
            </div>

            <!-- Result Count -->
            <div class="result-info">
                <p id="resultCount">Menampilkan 6 event</p>
            </div>
        </div>

        <!-- ========================================
             GRID EVENTS
             Tampilan card event
             ======================================== -->
        <div class="events-grid" id="eventsGrid"></div>

        <!-- Empty State (jika tidak ada hasil) -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">üîç</div>
            <h3>Tidak Ada Event Ditemukan</h3>
            <p>Coba ubah filter atau kata kunci pencarian Anda.</p>
            <button class="btn-submit" onclick="resetFilters()">Reset Filter</button>
        </div>
    </div>

    <!-- Modal Pemesanan -->
    <div class="modal" id="bookingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Form Pemesanan</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script src="js/script.js"></script>
    
    <script>
        // ========================================
        // DATA EVENT
        // Tambahkan field 'category' untuk filter
        // Tambahkan field 'image' untuk poster event
        // ========================================
        const events = [
            {
                id: 1,
                title: "Java Jazz Festival 2025",
                date: "15-17 Maret 2025",
                location: "JIExpo Kemayoran, Jakarta",
                price: 750000,
                category: "musik", // Kategori untuk filter
                icon: "üéµ",
                image: "images/bruno mars.jpg" // Path ke gambar poster
            },
            {
                id: 2,
                title: "Dewa 19 Reunion Concert",
                date: "5 April 2025",
                location: "GBK Stadium, Jakarta",
                price: 500000,
                category: "musik",
                icon: "üéµ",
                image: "images/garna vibe.jpg"
            },
            {
                id: 3,
                title: "Nadin Amizah",
                date: "20 April 2025",
                location: "Balai Sarbini, Jakarta",
                price: 250000,
                category: "musik",
                icon: "üéµ",
                image: "images/nadin amizah.jpg"
            },
            {
                id: 4,
                title: "Seminar Teknologi 2025",
                date: "10 Mei 2025",
                location: "Gedung ICE BSD, Tangerang",
                price: 150000,
                category: "seminar",
                icon: "üíª",
                image: "images/nights of beats.jpg"
            },
            {
                id: 5,
                title: "Festival Kuliner Nusantara",
                date: "25 Mei 2025",
                location: "Monas, Jakarta Pusat",
                price: 50000,
                category: "kuliner",
                icon: "üçú",
                image: "images/sunday.jpg"
            },
            {
                id: 6,
                title: "Theater Musical Laskar Pelangi",
                date: "1 Juni 2025",
                location: "Teater Jakarta",
                price: 300000,
                category: "teater",
                icon: "üé≠",
                image: "images/teater.jpg"
            },
            {
                id: 7,
                title: "Gojo Mon Jazz",
                date: "12 April 2025",
                location: "Stadion Utama",
                price: 48000,
                category: "konser",
                icon: "üé∏",
                image: "images/jazz.jpeg"
            },
            {
                id: 8,
                title: "Abertura Dot",
                date: "10 Januari 2025",
                location: "Salvador",
                price: 600000,
                category: "konser",
                icon: "üé∏",
                image: "images/line up.jpg"
            },
            {
                id: 9,
                title: "Special DJ Fest",
                date: "7 Januari 2025",
                location: "Panggung Raya Jakarta",
                price: 40000,
                category: "konser",
                icon: "üé∏",
                image: "images/music festival.jpeg"
            },
            {
                id: 10,
                title: "Hindia.Feast",
                date: "1 November 2025",
                location: "Surabaya",
                price: 240000,
                category: "musik",
                icon: "üéµ",
                image: "images/hindiaa.jpeg"
            },
            {
                id: 11,
                title: "Deny Caknan Music",
                date: " 6 September 2024",
                location: "Seven Dream City",
                price: 150000,
                category: "musik",
                icon: "üéµ",
                image: "images/denycknan.jpeg"
            },
            {
                id: 12,
                title: "Aurora Music Festival",
                date: "6 April 2026",
                location: "Calrk Global City",
                price: 260000,
                category: "musik",
                icon: "üéµ",
                image: "images/aurora.jpg"
            }




        ];

        // ========================================
        // VARIABEL GLOBAL
        // ========================================
        
        // Jumlah tiket per event
        const ticketCounts = {};
        events.forEach(event => {
            ticketCounts[event.id] = 0;
        });

        // Array untuk menyimpan event yang sedang ditampilkan (hasil filter)
        let displayedEvents = [...events]; // Copy semua event di awal

        // ========================================
        // PROTEKSI HALAMAN
        // ========================================
        function checkAuth() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return null;
            }
            return JSON.parse(currentUser);
        }

        // ========================================
        // RENDER EVENTS
        // Tampilkan event di layar (gunakan displayedEvents, bukan events)
        // ========================================
        function renderEvents() {
            const grid = document.getElementById('eventsGrid');
            const emptyState = document.getElementById('emptyState');
            
            // Cek apakah ada event yang ditampilkan
            if (displayedEvents.length === 0) {
                // Tidak ada event, tampilkan empty state
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                document.getElementById('resultCount').textContent = 'Tidak ada event ditemukan';
                return;
            }

            // Sembunyikan empty state
            emptyState.style.display = 'none';

            // Update result count
            document.getElementById('resultCount').textContent = 
                `Menampilkan ${displayedEvents.length} event`;

            // Generate HTML untuk setiap event yang ditampilkan
            grid.innerHTML = displayedEvents.map(event => `
                <div class="event-card">
                    <!-- Event Poster/Image -->
                    <div class="event-poster">
                        <img src="${event.image}" alt="${event.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <!-- Fallback icon jika gambar gagal load -->
                        <div class="event-icon-fallback" style="display: none;">${event.icon}</div>
                    </div>
                    
                    <div class="event-info">
                        <h3 class="event-title">${event.title}</h3>
                        <p class="event-date">üìÖ ${event.date}</p>
                        <p class="event-location">üìç ${event.location}</p>
                        <p class="event-price">Rp ${event.price.toLocaleString('id-ID')}</p>
                        
                        <div class="ticket-selector">
                            <button onclick="decreaseTicket(${event.id})">-</button>
                            <span id="count-${event.id}">0</span>
                            <button onclick="increaseTicket(${event.id})">+</button>
                            <span style="margin-left: 10px; color: #666;">tiket</span>
                        </div>
                        
                        <button 
                            class="btn-book" 
                            id="btn-${event.id}" 
                            onclick="openBookingForm(${event.id})" 
                            disabled>
                            Pesan Sekarang
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ========================================
        // TICKET SELECTOR
        // ========================================
        function increaseTicket(eventId) {
            if (ticketCounts[eventId] < 10) {
                ticketCounts[eventId]++;
                updateTicketDisplay(eventId);
            }
        }

        function decreaseTicket(eventId) {
            if (ticketCounts[eventId] > 0) {
                ticketCounts[eventId]--;
                updateTicketDisplay(eventId);
            }
        }

        //update angka di layar
        function updateTicketDisplay(eventId) {
            document.getElementById(`count-${eventId}`).textContent = ticketCounts[eventId];
            document.getElementById(`btn-${eventId}`).disabled = ticketCounts[eventId] === 0;
        }

        // ========================================
        // FILTER & SEARCH FUNCTIONS
        // Fungsi untuk filter dan search event
        // ========================================
        
        /**
         * APPLY FILTERS
         * Fungsi utama yang dipanggil setiap kali filter berubah
         * Menggabungkan: Search + Filter Kategori + Filter Harga + Sort
         */
        function applyFilters() {
            // 1. Ambil nilai dari semua filter
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('filterCategory').value;
            const priceFilter = document.getElementById('filterPrice').value;
            const sortBy = document.getElementById('sortBy').value;

            // 2. Mulai dari semua event
            let filtered = [...events]; // Copy array events

            // 3. FILTER: Berdasarkan Search Query
            // Cari event yang judulnya mengandung kata yang dicari
            if (searchQuery !== '') {
                filtered = filtered.filter(event => 
                    event.title.toLowerCase().includes(searchQuery) ||
                    event.location.toLowerCase().includes(searchQuery)
                );
            }

            // 4. FILTER: Berdasarkan Kategori
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(event => event.category === categoryFilter);
            }

            // 5. FILTER: Berdasarkan Range Harga
            if (priceFilter !== 'all') {
                // Parse range harga (format: "100000-300000")
                const [minPrice, maxPrice] = priceFilter.split('-').map(Number);
                
                filtered = filtered.filter(event => 
                    event.price >= minPrice && event.price <= maxPrice
                );
            }

            // 6. SORT: Urutkan hasil filter
            filtered = sortEvents(filtered, sortBy);

            // 7. Update displayedEvents dan render ulang
            displayedEvents = filtered;
            renderEvents();
        }

        /**
         * SORT EVENTS
         * Fungsi untuk mengurutkan array event
         * @param {Array} eventsArray - Array event yang mau diurutkan
         * @param {String} sortType - Tipe sorting
         * @returns {Array} - Array event yang sudah diurutkan
         */
        function sortEvents(eventsArray, sortType) {
            let sorted = [...eventsArray]; // Copy array

            switch(sortType) {
                case 'price-low':
                    // Urutkan dari harga termurah ke termahal
                    sorted.sort((a, b) => a.price - b.price);
                    break;
                
                case 'price-high':
                    // Urutkan dari harga termahal ke termurah
                    sorted.sort((a, b) => b.price - a.price);
                    break;
                
                case 'name-asc':
                    // Urutkan nama A-Z
                    sorted.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                
                case 'name-desc':
                    // Urutkan nama Z-A
                    sorted.sort((a, b) => b.title.localeCompare(a.title));
                    break;
                
                default:
                    // Default: tidak diurutkan (sesuai urutan asli)
                    break;
            }

            return sorted;
        }

        /**
         * RESET FILTERS
         * Reset semua filter ke default
         */
        function resetFilters() {
            // Reset semua input filter ke nilai default
            document.getElementById('searchInput').value = '';
            document.getElementById('filterCategory').value = 'all';
            document.getElementById('filterPrice').value = 'all';
            document.getElementById('sortBy').value = 'default';

            // Tampilkan semua event
            displayedEvents = [...events];
            renderEvents();
        }

        // ========================================
        // BOOKING FORM
        // ========================================
        function openBookingForm(eventId) {
            const event = events.find(e => e.id === eventId);
            const ticketCount = ticketCounts[eventId];
            const totalPrice = event.price * ticketCount;
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));

            const formHtml = `
                <form id="bookingForm" onsubmit="submitBooking(event, ${eventId})">
                    <div class="order-summary">
                        <h3>Ringkasan Pesanan</h3>
                        <div class="summary-item">
                            <span>Event:</span>
                            <span>${event.title}</span>
                        </div>
                        <div class="summary-item">
                            <span>Jumlah Tiket:</span>
                            <span>${ticketCount} tiket</span>
                        </div>
                        <div class="summary-item">
                            <span>Harga per Tiket:</span>
                            <span>Rp ${event.price.toLocaleString('id-ID')}</span>
                        </div>
                        <div class="summary-total">
                            <span>Total:</span>
                            <span>Rp ${totalPrice.toLocaleString('id-ID')}</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Nama Lengkap</label>
                        <input type="text" value="${currentUser.name}" readonly>
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" value="${currentUser.email}" readonly>
                    </div>

                    <div class="form-group">
                        <label>No. Telepon</label>
                        <input type="tel" value="${currentUser.phone}" readonly>
                    </div>

                    <div class="form-group">
                        <label>Metode Pembayaran *</label>
                        <select id="payment" required onchange="togglePaymentDetails()">
                            <option value="">Pilih Metode Pembayaran</option>
                            <option value="transfer">Transfer Bank</option>
                            <option value="ewallet">E-Wallet (OVO/GoPay/Dana)</option>
                            <option value="cc">Kartu Kredit</option>
                        </select>
                    </div>

                    <!-- Detail Transfer Bank (Hidden by default) -->
                    <div id="transferDetails" style="display: none;">
                        <div class="form-group">
                            <label>Pilih Bank Tujuan *</label>
                            <select id="bankDestination" required>
                                <option value="">-- Pilih Bank --</option>
                                <option value="BCA">BCA - 1234567890 (a.n EventKu)</option>
                                <option value="Mandiri">Mandiri - 9876543210 (a.n EventKu)</option>
                                <option value="BNI">BNI - 5555666677 (a.n EventKu)</option>
                                <option value="BRI">BRI - 8888999900 (a.n EventKu)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Nama Pemilik Rekening Pengirim *</label>
                            <input type="text" id="accountName" placeholder="Masukkan nama sesuai rekening" required>
                        </div>

                        <div class="form-group">
                            <label>Nomor Rekening Pengirim *</label>
                            <input type="text" id="accountNumber" placeholder="Contoh: 1234567890" pattern="[0-9]+" required>
                        </div>

                        <div class="form-group">
                            <label>Upload Bukti Transfer *</label>
                            <input type="file" id="paymentProof" accept="image/*" required>
                            <small style="color: #666; font-size: 12px;">Format: JPG, PNG, atau PDF (Max 2MB)</small>
                        </div>
                    </div>

                    <!-- Detail E-Wallet -->
                    <div id="ewalletDetails" style="display: none;">
                        <div class="form-group">
                            <label>Pilih E-Wallet *</label>
                            <select id="ewalletType" required>
                                <option value="">-- Pilih E-Wallet --</option>
                                <option value="OVO">OVO - 08123456789</option>
                                <option value="GoPay">GoPay - 08123456789</option>
                                <option value="Dana">Dana - 08123456789</option>
                                <option value="ShopeePay">ShopeePay - 08123456789</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Nomor E-Wallet Pengirim *</label>
                            <input type="tel" id="ewalletNumber" placeholder="Contoh: 08123456789" pattern="08[0-9]{8,11}" required>
                        </div>

                        <div class="form-group">
                            <label>Upload Bukti Pembayaran *</label>
                            <input type="file" id="ewalletProof" accept="image/*" required>
                            <small style="color: #666; font-size: 12px;">Screenshot konfirmasi pembayaran (Max 2MB)</small>
                        </div>
                    </div>

                    <!-- Detail Kartu Kredit -->
                    <div id="ccDetails" style="display: none;">
                        <div class="payment-info-box">
                            <p>üí≥ Pembayaran dengan Kartu Kredit akan diproses melalui payment gateway.</p>
                            <p>Anda akan diarahkan ke halaman pembayaran setelah konfirmasi.</p>
                        </div>
                    </div>

                    <button type="submit" class="btn-submit">Konfirmasi Pemesanan</button>
                </form>
            `;

            document.getElementById('modalBody').innerHTML = formHtml;
            document.getElementById('bookingModal').classList.add('active');
        }

        // ========================================
        // TOGGLE PAYMENT DETAILS
        // ========================================
        function togglePaymentDetails() {
            const paymentMethod = document.getElementById('payment').value;
            
            // Hide semua detail payment
            document.getElementById('transferDetails').style.display = 'none';
            document.getElementById('ewalletDetails').style.display = 'none';
            document.getElementById('ccDetails').style.display = 'none';

            // Hapus required dari semua field payment detail
            ['bankDestination', 'accountName', 'accountNumber', 'paymentProof'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.removeAttribute('required');
            });
            ['ewalletType', 'ewalletNumber', 'ewalletProof'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.removeAttribute('required');
            });

            // Show detail sesuai metode yang dipilih
            if (paymentMethod === 'transfer') {
                document.getElementById('transferDetails').style.display = 'block';
                ['bankDestination', 'accountName', 'accountNumber', 'paymentProof'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.setAttribute('required', 'required');
                });
            } else if (paymentMethod === 'ewallet') {
                document.getElementById('ewalletDetails').style.display = 'block';
                ['ewalletType', 'ewalletNumber', 'ewalletProof'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.setAttribute('required', 'required');
                });
            } else if (paymentMethod === 'cc') {
                document.getElementById('ccDetails').style.display = 'block';
            }
        }

        // ========================================
        // SUBMIT BOOKING - SIMPAN KE LOCALSTORAGE
        // ========================================
        function submitBooking(e, eventId) {
            e.preventDefault();
            
            // ambil data
            const event = events.find(ev => ev.id === eventId);
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            const payment = document.getElementById('payment').value;
            const ticketCount = ticketCounts[eventId];
            const totalPrice = event.price * ticketCount;

            // Kumpulkan detail pembayaran
            let paymentDetails = {
                method: payment
            };

            // Jika Transfer Bank
            if (payment === 'transfer') {
                const bank = document.getElementById('bankDestination').value;
                const accountName = document.getElementById('accountName').value;
                const accountNumber = document.getElementById('accountNumber').value;
                const proofFile = document.getElementById('paymentProof').files[0];

                // Validasi file size (max 2MB)
                if (proofFile && proofFile.size > 2 * 1024 * 1024) {
                    alert('‚ö†Ô∏è Ukuran file terlalu besar! Maksimal 2MB');
                    return;
                }

                // Simpan sebagai base64 (untuk simulasi, di production pakai server)
                if (proofFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        paymentDetails.bank = bank;
                        paymentDetails.accountName = accountName;
                        paymentDetails.accountNumber = accountNumber;
                        paymentDetails.proofImage = e.target.result;
                        paymentDetails.proofFileName = proofFile.name;
                        
                        // Lanjutkan simpan booking
                        saveBooking(event, currentUser, ticketCount, totalPrice, paymentDetails, eventId);
                    };
                    reader.readAsDataURL(proofFile);
                    return; // Tunggu file upload selesai
                }
            }
            // Jika E-Wallet
            else if (payment === 'ewallet') {
                const ewalletType = document.getElementById('ewalletType').value;
                const ewalletNumber = document.getElementById('ewalletNumber').value;
                const proofFile = document.getElementById('ewalletProof').files[0];

                // Validasi file size
                if (proofFile && proofFile.size > 2 * 1024 * 1024) {
                    alert('‚ö†Ô∏è Ukuran file terlalu besar! Maksimal 2MB');
                    return;
                }

                if (proofFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        paymentDetails.ewalletType = ewalletType;
                        paymentDetails.ewalletNumber = ewalletNumber;
                        paymentDetails.proofImage = e.target.result;
                        paymentDetails.proofFileName = proofFile.name;
                        
                        saveBooking(event, currentUser, ticketCount, totalPrice, paymentDetails, eventId);
                    };
                    reader.readAsDataURL(proofFile);
                    return;
                }
            }

            // Jika Kartu Kredit (tidak perlu upload)
            saveBooking(event, currentUser, ticketCount, totalPrice, paymentDetails, eventId);
        }

        // ========================================
        // SAVE BOOKING TO LOCALSTORAGE
        // ========================================
        function saveBooking(event, currentUser, ticketCount, totalPrice, paymentDetails, eventId) {
            // Generate booking number
            const bookingNumber = 'BK' + Date.now().toString().slice(-8);
            const bookingDate = new Date().toLocaleString('id-ID');
            const timestamp = Date.now();

            // ‚≠ê PENTING: Buat object booking
            const newBooking = {
                bookingNumber: bookingNumber,
                timestamp: timestamp,
                userId: currentUser.id,
                userName: currentUser.name,
                userEmail: currentUser.email,
                userPhone: currentUser.phone,
                eventId: event.id,
                eventTitle: event.title,
                eventDate: event.date,
                eventLocation: event.location,
                eventIcon: event.icon,
                ticketCount: ticketCount,
                pricePerTicket: event.price,
                totalPrice: totalPrice,
                paymentMethod: paymentDetails.method,
                paymentDetails: paymentDetails, // Simpan detail pembayaran lengkap
                bookingDate: bookingDate,
                status: 'Pending' // Status: Pending, Lunas, Dibatalkan
            };
            
            // ‚≠ê PENTING: Ambil data bookings yang sudah ada
            let bookings = JSON.parse(localStorage.getItem('bookings')) || [];
            
            // ‚≠ê PENTING: Tambahkan booking baru
            bookings.push(newBooking);
            
            // ‚≠ê PENTING: Simpan ke localStorage dengan key 'bookings'
            localStorage.setItem('bookings', JSON.stringify(bookings));

            // Tampilkan konfirmasi
            showBookingConfirmation(newBooking, currentUser, event, ticketCount, totalPrice, paymentDetails);
        }

        // ========================================
        // SHOW BOOKING CONFIRMATION
        // ========================================
        function showBookingConfirmation(booking, currentUser, event, ticketCount, totalPrice, paymentDetails) {
            const paymentLabel = getPaymentMethodLabel(paymentDetails);
            let paymentInfo = '';

            // Tambahkan info pembayaran detail
            if (paymentDetails.method === 'transfer') {
                paymentInfo = `
                    <p><strong>Bank Tujuan:</strong> ${paymentDetails.bank}</p>
                    <p><strong>Dari Rekening:</strong> ${paymentDetails.accountName} (${paymentDetails.accountNumber})</p>
                    <p><strong>Bukti Transfer:</strong> ‚úÖ Sudah diupload</p>
                `;
            } else if (paymentDetails.method === 'ewallet') {
                paymentInfo = `
                    <p><strong>E-Wallet:</strong> ${paymentDetails.ewalletType}</p>
                    <p><strong>Nomor:</strong> ${paymentDetails.ewalletNumber}</p>
                    <p><strong>Bukti Bayar:</strong> ‚úÖ Sudah diupload</p>
                `;
            } else if (paymentDetails.method === 'cc') {
                paymentInfo = `<p><strong>üí≥ Kartu Kredit</strong> - Menunggu verifikasi</p>`;
            }

            const confirmationHtml = `
                <div class="confirmation">
                    <div class="confirmation-icon">‚úÖ</div>
                    <h2>Pemesanan Berhasil!</h2>
                    <p>Terima kasih telah memesan tiket</p>
                    
                    <div class="booking-details">
                        <p><strong>No. Booking:</strong> ${booking.bookingNumber}</p>
                        <p><strong>Nama:</strong> ${currentUser.name}</p>
                        <p><strong>Email:</strong> ${currentUser.email}</p>
                        <p><strong>Event:</strong> ${event.title}</p>
                        <p><strong>Jumlah Tiket:</strong> ${ticketCount} tiket</p>
                        <p><strong>Total Bayar:</strong> Rp ${totalPrice.toLocaleString('id-ID')}</p>
                        <p><strong>Metode Pembayaran:</strong> ${paymentLabel}</p>
                        ${paymentInfo}
                        <p><strong>Status:</strong> <span style="color: #ffa502;">üü° Menunggu Verifikasi</span></p>
                    </div>

                    <p style="color: #666; font-size: 14px; margin: 15px 0;">
                        ${paymentDetails.method === 'cc' 
                            ? 'Pembayaran Anda sedang diproses.<br>' 
                            : 'Bukti pembayaran Anda akan diverifikasi dalam 1x24 jam.<br>'}
                        E-ticket akan dikirim ke email setelah pembayaran dikonfirmasi.<br>
                        Silakan cek di menu Riwayat untuk melihat detail pemesanan.
                    </p>

                    <a href="riwayat.html" class="btn-submit" style="display: inline-block; text-decoration: none; margin-bottom: 10px;">
                        üìú Lihat Riwayat Transaksi
                    </a>
                    <button class="btn-close-modal" onclick="closeModalAndReset()">Tutup</button>
                </div>
            `;

            document.getElementById('modalBody').innerHTML = confirmationHtml;
        }

        // ========================================
        // GET PAYMENT METHOD LABEL
        // ========================================
        function getPaymentMethodLabel(paymentDetails) {
            if (paymentDetails.method === 'transfer') {
                return `Transfer Bank (${paymentDetails.bank})`;
            } else if (paymentDetails.method === 'ewallet') {
                return `E-Wallet (${paymentDetails.ewalletType})`;
            } else if (paymentDetails.method === 'cc') {
                return 'Kartu Kredit';
            }
            return paymentDetails.method;
        }

        // ========================================
        // MODAL FUNCTIONS
        // ========================================
        function closeModal() {
            document.getElementById('bookingModal').classList.remove('active');
        }

        function closeModalAndReset() {
            closeModal();
            Object.keys(ticketCounts).forEach(key => {
                ticketCounts[key] = 0;
            });
            renderEvents();
        }

        // ========================================
        // LOGOUT
        // ========================================
        function handleLogout() {
            if (confirm('Yakin ingin logout?')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }

        // ========================================
        // INIT
        // ========================================
        window.onload = function() {
            const user = checkAuth();
            if (user) {
                document.getElementById('userName').textContent = `Halo, ${user.name}! üëã`;
                renderEvents();
            }
        };
    </script>
</body>
</html>