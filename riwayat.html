<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Transaksi - EventKu</title>
    <link rel="stylesheet" href="css/style.css">
    
    <!-- ========================================
         LIBRARY UNTUK E-TICKET
         - QRCode.js: Generate QR Code
         - html2canvas: Capture HTML ke Image
         - jsPDF: Generate PDF
         ======================================== -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="dashboard-body">
    
    <!-- Navbar - responsive & cute banget nih! üå∏ -->
    <nav class="navbar">
        <div class="nav-container">
            <!-- Logo & nama app (kiri banget) -->
            <div class="nav-brand">
                <img src="images/logo tiket.png" alt="EventKu Logo" class="logo-img">
                <h2>EventKu</h2>
            </div>
            
            <!-- Hamburger menu buat mobile (biar gampang navigasinya) üçî‚ú® -->
            <button class="hamburger-menu" onclick="toggleMobileMenu()" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <!-- Menu navigasi (bakal slide down di mobile) -->
            <div class="nav-menu" id="navMenu">
                <a href="dashboard.html" class="nav-link">
                    <img src="images/home icon.png" alt="Home" class="nav-icon"> Home
                </a>
                <a href="riwayat.html" class="nav-link active">
                    <img src="images/riwayaticon.png" alt="Riwayat" class="nav-icon"> Riwayat
                </a>
                <a href="profile.html" class="nav-link">
                    <img src="images/profil icon.jpg" alt="Profil" class="nav-icon"> Profil
                </a>
            </div>
            
            <!-- User info & tombol logout (kanan banget) -->
            <div class="nav-user">
                <span id="userName">Loading...</span>
                <button class="btn-logout" onclick="handleLogout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Header Riwayat -->
        <div class="dashboard-header">
            <h1>üìú Riwayat Transaksi</h1>
            <p>Semua pemesanan tiket kamu ada di sini</p>
        </div>

        <!-- Filter Status -->
        <div class="filter-section">
            <h3>Filter by Status:</h3>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterByStatus('all')">
                    Semua (<span id="count-all">0</span>)
                </button>
                <button class="filter-btn" onclick="filterByStatus('Pending')">
                    üü° Pending (<span id="count-pending">0</span>)
                </button>
                <button class="filter-btn" onclick="filterByStatus('Lunas')">
                    üü¢ Lunas (<span id="count-lunas">0</span>)
                </button>
                <button class="filter-btn" onclick="filterByStatus('Dibatalkan')">
                    üî¥ Dibatalkan (<span id="count-dibatalkan">0</span>)
                </button>
            </div>
        </div>

        <!-- List Transaksi -->
        <div id="transactionList"></div>

        <!-- Empty State (jika belum ada transaksi) -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-icon">üì≠</div>
            <h3>Belum Ada Transaksi</h3>
            <p>Kamu belum pernah memesan tiket.</p>
            <a href="dashboard.html" class="btn-submit">Mulai Pesan Tiket</a>
        </div>
    </div>

    <!-- Modal Detail Transaksi -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detail Transaksi</h2>
                <button class="close-btn" onclick="closeDetailModal()">&times;</button>
            </div>
            <div id="detailBody"></div>
        </div>
    </div>

    <!-- ========================================
         MODAL E-TICKET
         Modal untuk preview & download tiket
         ======================================== -->
    <div class="modal" id="ticketModal">
        <div class="modal-content ticket-modal-content">
            <div class="modal-header">
                <h2>üé´ E-Ticket Anda</h2>
                <button class="close-btn" onclick="closeTicketModal()">&times;</button>
            </div>
            
            <!-- Container untuk tiket yang akan di-download -->
            <div id="ticketContainer"></div>

            <!-- Action Buttons -->
            <div class="ticket-actions">
                <button class="btn-download-pdf" onclick="downloadTicketPDF()">
                    üìÑ Download PDF
                </button>
                <button class="btn-download-image" onclick="downloadTicketImage()">
                    üñºÔ∏è Download Image
                </button>
                <button class="btn-close-modal" onclick="closeTicketModal()">
                    Tutup
                </button>
            </div>
        </div>
    </div>

    <script src="js/script.js"></script>
    
    <script>
        // Variabel global untuk filter
        let currentFilter = 'all';
        let allBookings = [];

        // ========================================
        // PROTEKSI HALAMAN
        // ========================================
        function checkAuth() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = 'index.html';
                return null;
            }
            return JSON.parse(currentUser);
        }

        // ========================================
        // LOAD & DISPLAY BOOKINGS
        // ========================================
        function loadBookings() {
            const currentUser = checkAuth();
            if (!currentUser) return;

            // Ambil semua bookings dari localStorage
            const allBookingsData = JSON.parse(localStorage.getItem('bookings')) || [];
            
            // Filter: hanya ambil booking milik user yang login
            allBookings = allBookingsData.filter(b => b.userId === currentUser.id);

            // Update counter status
            updateStatusCount();

            // Tampilkan list transaksi
            displayBookings(allBookings);
        }

        // ========================================
        // UPDATE COUNTER STATUS
        // ========================================
        function updateStatusCount() {
            const countAll = allBookings.length;
            const countPending = allBookings.filter(b => b.status === 'Pending').length;
            const countLunas = allBookings.filter(b => b.status === 'Lunas').length;
            const countDibatalkan = allBookings.filter(b => b.status === 'Dibatalkan').length;

            document.getElementById('count-all').textContent = countAll;
            document.getElementById('count-pending').textContent = countPending;
            document.getElementById('count-lunas').textContent = countLunas;
            document.getElementById('count-dibatalkan').textContent = countDibatalkan;
        }

        // ========================================
        // DISPLAY BOOKINGS
        // ========================================
        function displayBookings(bookings) {
            const listContainer = document.getElementById('transactionList');
            const emptyState = document.getElementById('emptyState');

            // Jika tidak ada booking, tampilkan empty state
            if (bookings.length === 0) {
                listContainer.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            // Sembunyikan empty state
            emptyState.style.display = 'none';

            // Sort by timestamp (terbaru dulu)
            bookings.sort((a, b) => b.timestamp - a.timestamp);

            // Generate HTML untuk setiap booking
            listContainer.innerHTML = bookings.map(booking => {
                // Tentukan warna status
                let statusColor = '#ffa502'; // Orange untuk Pending
                let statusIcon = 'üü°';
                
                if (booking.status === 'Lunas') {
                    statusColor = '#26de81';
                    statusIcon = 'üü¢';
                } else if (booking.status === 'Dibatalkan') {
                    statusColor = '#fc5c65';
                    statusIcon = 'üî¥';
                }

                return `
                    <div class="transaction-card">
                        <div class="transaction-header">
                            <div class="transaction-number">
                                <strong>Booking #${booking.bookingNumber}</strong>
                                <span class="transaction-date">${booking.bookingDate}</span>
                            </div>
                            <div class="transaction-status" style="background: ${statusColor};">
                                ${statusIcon} ${booking.status}
                            </div>
                        </div>

                        <div class="transaction-body">
                            <div class="transaction-event">
                                <h3>${booking.eventTitle}</h3>
                                <p>üìÖ ${booking.eventDate}</p>
                                <p>üìç ${booking.eventLocation}</p>
                            </div>

                            <div class="transaction-details">
                                <div class="detail-item">
                                    <span>Jumlah Tiket:</span>
                                    <strong>${booking.ticketCount} tiket</strong>
                                </div>
                                <div class="detail-item">
                                    <span>Total Harga:</span>
                                    <strong style="color: #667eea;">Rp ${booking.totalPrice.toLocaleString('id-ID')}</strong>
                                </div>
                                <div class="detail-item">
                                    <span>Pembayaran:</span>
                                    <strong>${getPaymentLabel(booking.paymentMethod)}</strong>
                                </div>
                            </div>
                        </div>

                        <div class="transaction-actions">
                            <button class="btn-detail" onclick="showDetail('${booking.bookingNumber}')">
                                üìã Lihat Detail
                            </button>
                            ${booking.status === 'Pending' ? `
                                <button class="btn-upload" onclick="uploadPaymentProof('${booking.bookingNumber}')">
                                    üì§ Upload Bukti Bayar
                                </button>
                                <button class="btn-cancel" onclick="updateStatus('${booking.bookingNumber}', 'Dibatalkan')">
                                    ‚ùå Batalkan
                                </button>
                            ` : ''}
                            ${booking.status === 'Lunas' ? `
                                <button class="btn-print" onclick="showTicketPreview('${booking.bookingNumber}')">
                                    üé´ Download E-Ticket
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========================================
        // FILTER BY STATUS
        // ========================================
        function filterByStatus(status) {
            currentFilter = status;

            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Filter bookings
            let filteredBookings = allBookings;
            if (status !== 'all') {
                filteredBookings = allBookings.filter(b => b.status === status);
            }

            // Display filtered bookings
            displayBookings(filteredBookings);
        }

        // ========================================
        // SHOW DETAIL MODAL
        // ========================================
        function showDetail(bookingNumber) {
            // Cari booking berdasarkan booking number
            const booking = allBookings.find(b => b.bookingNumber === bookingNumber);
            if (!booking) return;

            // Generate HTML detail
            const detailHtml = `
                <div class="detail-content">
                    <div class="detail-header">
                        <h3>Booking #${booking.bookingNumber}</h3>
                        <div class="detail-status" style="background: ${getStatusColor(booking.status)};">
                            ${getStatusIcon(booking.status)} ${booking.status}
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>üìã Info Pemesanan</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span>Tanggal Booking:</span>
                                <strong>${booking.bookingDate}</strong>
                            </div>
                            <div class="detail-item">
                                <span>Status:</span>
                                <strong>${booking.status}</strong>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>üé´ Info Event</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span>Nama Event:</span>
                                <strong>${booking.eventTitle}</strong>
                            </div>
                            <div class="detail-item">
                                <span>Tanggal Event:</span>
                                <strong>${booking.eventDate}</strong>
                            </div>
                            <div class="detail-item">
                                <span>Lokasi:</span>
                                <strong>${booking.eventLocation}</strong>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>üë§ Info Pemesan</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span>Nama:</span>
                                <strong>${booking.userName}</strong>
                            </div>
                            <div class="detail-item">
                                <span>Email:</span>
                                <strong>${booking.userEmail}</strong>
                            </div>
                            <div class="detail-item">
                                <span>No. Telepon:</span>
                                <strong>${booking.userPhone}</strong>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>üí∞ Info Pembayaran</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span>Jumlah Tiket:</span>
                                <strong>${booking.ticketCount} tiket</strong>
                            </div>
                            <div class="detail-item">
                                <span>Harga per Tiket:</span>
                                <strong>Rp ${booking.pricePerTicket.toLocaleString('id-ID')}</strong>
                            </div>
                            <div class="detail-item">
                                <span>Total Harga:</span>
                                <strong style="color: #667eea; font-size: 18px;">Rp ${booking.totalPrice.toLocaleString('id-ID')}</strong>
                            </div>
                            <div class="detail-item">
                                <span>Metode Pembayaran:</span>
                                <strong>${getPaymentLabel(booking.paymentMethod)}</strong>
                            </div>
                        </div>
                        ${getPaymentDetailsHTML(booking)}
                    </div>

                    <button class="btn-close-modal" onclick="closeDetailModal()">Tutup</button>
                </div>
            `;

            document.getElementById('detailBody').innerHTML = detailHtml;
            document.getElementById('detailModal').classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // ========================================
        // UPDATE STATUS (HANYA UNTUK BATAL)
        // ========================================
        function updateStatus(bookingNumber, newStatus) {
            // User hanya bisa membatalkan transaksi
            if (newStatus !== 'Dibatalkan') {
                alert('‚ö†Ô∏è Aksi tidak diizinkan!');
                return;
            }

            if (!confirm('Batalkan transaksi ini?')) return;

            // Ambil semua bookings
            let allBookingsData = JSON.parse(localStorage.getItem('bookings')) || [];

            // Update status booking yang dipilih
            allBookingsData = allBookingsData.map(b => {
                if (b.bookingNumber === bookingNumber) {
                    b.status = newStatus;
                }
                return b;
            });

            // Simpan kembali
            localStorage.setItem('bookings', JSON.stringify(allBookingsData));

            // Reload data
            loadBookings();

            // Tampilkan notifikasi
            alert(`‚úÖ Transaksi berhasil dibatalkan`);
        }

        // ========================================
        // UPLOAD PAYMENT PROOF
        // ========================================
        function uploadPaymentProof(bookingNumber) {
            // Cari booking
            const booking = allBookings.find(b => b.bookingNumber === bookingNumber);
            if (!booking) return;

            // Buat form upload
            const uploadFormHtml = `
                <div class="upload-proof-form">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üì§ Upload Bukti Pembayaran</h3>
                    <p style="color: #666; margin-bottom: 15px;">Booking #${bookingNumber}</p>

                    <form id="uploadForm" onsubmit="submitPaymentProof(event, '${bookingNumber}')">
                        ${booking.paymentMethod === 'transfer' ? `
                            <div class="form-group">
                                <label>Pilih Bank Tujuan *</label>
                                <select id="uploadBank" required>
                                    <option value="">-- Pilih Bank --</option>
                                    <option value="BCA">BCA - 1234567890 (a.n EventKu)</option>
                                    <option value="Mandiri">Mandiri - 9876543210 (a.n EventKu)</option>
                                    <option value="BNI">BNI - 5555666677 (a.n EventKu)</option>
                                    <option value="BRI">BRI - 8888999900 (a.n EventKu)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Nama Pemilik Rekening *</label>
                                <input type="text" id="uploadAccountName" placeholder="Sesuai rekening" required>
                            </div>
                            <div class="form-group">
                                <label>Nomor Rekening *</label>
                                <input type="text" id="uploadAccountNumber" placeholder="1234567890" pattern="[0-9]+" required>
                            </div>
                        ` : booking.paymentMethod === 'ewallet' ? `
                            <div class="form-group">
                                <label>Pilih E-Wallet *</label>
                                <select id="uploadEwallet" required>
                                    <option value="">-- Pilih E-Wallet --</option>
                                    <option value="OVO">OVO</option>
                                    <option value="GoPay">GoPay</option>
                                    <option value="Dana">Dana</option>
                                    <option value="ShopeePay">ShopeePay</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Nomor E-Wallet *</label>
                                <input type="tel" id="uploadEwalletNumber" placeholder="08123456789" pattern="08[0-9]{8,11}" required>
                            </div>
                        ` : ''}

                        <div class="form-group">
                            <label>Upload Bukti Bayar *</label>
                            <input type="file" id="uploadProofFile" accept="image/*" required>
                            <small>Format: JPG, PNG (Max 2MB)</small>
                        </div>

                        <button type="submit" class="btn-submit">Upload Bukti</button>
                        <button type="button" class="btn-close-modal" onclick="closeDetailModal()" style="margin-top: 10px;">Batal</button>
                    </form>
                </div>
            `;

            document.getElementById('detailBody').innerHTML = uploadFormHtml;
            document.getElementById('detailModal').classList.add('active');
        }

        function submitPaymentProof(e, bookingNumber) {
            e.preventDefault();

            const proofFile = document.getElementById('uploadProofFile').files[0];
            
            // Validasi ukuran file
            if (proofFile && proofFile.size > 2 * 1024 * 1024) {
                alert('‚ö†Ô∏è Ukuran file terlalu besar! Maksimal 2MB');
                return;
            }

            // Baca file sebagai base64
            const reader = new FileReader();
            reader.onload = function(e) {
                // Ambil semua bookings
                let allBookingsData = JSON.parse(localStorage.getItem('bookings')) || [];

                // Update booking dengan payment proof
                allBookingsData = allBookingsData.map(b => {
                    if (b.bookingNumber === bookingNumber) {
                        if (!b.paymentDetails) {
                            b.paymentDetails = { method: b.paymentMethod };
                        }

                        // Simpan detail sesuai metode
                        if (b.paymentMethod === 'transfer') {
                            b.paymentDetails.bank = document.getElementById('uploadBank').value;
                            b.paymentDetails.accountName = document.getElementById('uploadAccountName').value;
                            b.paymentDetails.accountNumber = document.getElementById('uploadAccountNumber').value;
                        } else if (b.paymentMethod === 'ewallet') {
                            b.paymentDetails.ewalletType = document.getElementById('uploadEwallet').value;
                            b.paymentDetails.ewalletNumber = document.getElementById('uploadEwalletNumber').value;
                        }

                        b.paymentDetails.proofImage = e.target.result;
                        b.paymentDetails.proofFileName = proofFile.name;
                        b.paymentDetails.uploadedAt = new Date().toLocaleString('id-ID');
                    }
                    return b;
                });

                // Simpan kembali
                localStorage.setItem('bookings', JSON.stringify(allBookingsData));

                // Reload dan tutup modal
                loadBookings();
                closeDetailModal();

                alert('‚úÖ Bukti pembayaran berhasil diupload!\n\nBukti Anda akan diverifikasi dalam 1x24 jam.');
            };

            reader.readAsDataURL(proofFile);
        }

        // ========================================
        // E-TICKET FUNCTIONS
        // Fungsi untuk generate & download e-ticket
        // ========================================
        
        /**
         * SHOW TICKET PREVIEW
         * Tampilkan modal preview tiket sebelum download
         * @param {String} bookingNumber - Nomor booking
         */
        function showTicketPreview(bookingNumber) {
            // Cari booking berdasarkan nomor
            const booking = allBookings.find(b => b.bookingNumber === bookingNumber);
            if (!booking) {
                alert('‚ö†Ô∏è Booking tidak ditemukan!');
                return;
            }

            // Cek status harus Lunas
            if (booking.status !== 'Lunas') {
                alert('‚ö†Ô∏è Hanya tiket yang sudah Lunas yang bisa didownload!');
                return;
            }

            // Generate HTML tiket yang cantik
            const ticketHTML = generateTicketHTML(booking);
            
            // Masukkan ke container
            document.getElementById('ticketContainer').innerHTML = ticketHTML;
            
            // Generate QR Code
            // QR Code berisi: booking number + user name + event title
            const qrData = `EVENTKUTIX-${booking.bookingNumber}-${booking.userName}-${booking.eventTitle}`;
            
            // Hapus QR code lama (kalau ada)
            document.getElementById('qrcode').innerHTML = '';
            
            // Generate QR code baru
            new QRCode(document.getElementById('qrcode'), {
                text: qrData,
                width: 150,
                height: 150,
                colorDark: '#000000',
                colorLight: '#ffffff',
            });

            // Tampilkan modal
            document.getElementById('ticketModal').classList.add('active');
        }

        /**
         * GENERATE TICKET HTML
         * Buat HTML design tiket yang cantik
         * @param {Object} booking - Data booking
         * @returns {String} - HTML string
         */
        function generateTicketHTML(booking) {
            const currentDate = new Date().toLocaleDateString('id-ID');
            
            return `
                <div class="e-ticket" id="eTicket">
                    <!-- Header Tiket -->
                    <div class="ticket-header">
                        <div class="ticket-logo">
                            <img src="images/logo tiket.jpg" alt="EventKu Logo" class="logo-img-ticket">
                            <h1>EventKu</h1>
                            <p>E-Ticket Digital</p>
                        </div>
                        <div class="ticket-status">
                            <span class="status-badge">‚úì VERIFIED</span>
                        </div>
                    </div>

                    <!-- Event Info -->
                    <div class="ticket-event-info">
                        <div class="event-icon-large">${booking.eventIcon || 'üéµ'}</div>
                        <h2 class="event-title-large">${booking.eventTitle}</h2>
                        <p class="event-subtitle">Official E-Ticket</p>
                    </div>

                    <!-- Ticket Details Grid -->
                    <div class="ticket-details-grid">
                        <div class="ticket-detail-item">
                            <span class="detail-label">üìÖ Tanggal Event</span>
                            <span class="detail-value">${booking.eventDate}</span>
                        </div>
                        <div class="ticket-detail-item">
                            <span class="detail-label">üìç Lokasi</span>
                            <span class="detail-value">${booking.eventLocation}</span>
                        </div>
                        <div class="ticket-detail-item">
                            <span class="detail-label">üë§ Nama Pemesan</span>
                            <span class="detail-value">${booking.userName}</span>
                        </div>
                        <div class="ticket-detail-item">
                            <span class="detail-label">üé´ Jumlah Tiket</span>
                            <span class="detail-value">${booking.ticketCount} Tiket</span>
                        </div>
                        <div class="ticket-detail-item">
                            <span class="detail-label">üí∞ Total Bayar</span>
                            <span class="detail-value">Rp ${booking.totalPrice.toLocaleString('id-ID')}</span>
                        </div>
                        <div class="ticket-detail-item">
                            <span class="detail-label">üìß Email</span>
                            <span class="detail-value">${booking.userEmail}</span>
                        </div>
                    </div>

                    <!-- QR Code Section -->
                    <div class="ticket-qr-section">
                        <div class="qr-wrapper">
                            <div id="qrcode"></div>
                        </div>
                        <div class="qr-info">
                            <p class="booking-number">Booking #${booking.bookingNumber}</p>
                            <p class="qr-instruction">Scan QR Code saat masuk venue</p>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="ticket-footer">
                        <p>Dicetak pada: ${currentDate}</p>
                        <p class="ticket-notice">‚ö†Ô∏è Tiket ini tidak dapat dipindahtangankan</p>
                        <p class="ticket-notice">Harap tunjukkan tiket ini beserta identitas diri saat masuk venue</p>
                    </div>

                    <!-- Decorative Elements -->
                    <div class="ticket-perforation"></div>
                </div>
            `;
        }

        /**
         * DOWNLOAD TICKET AS PDF
         * Download tiket dalam format PDF
         */
        async function downloadTicketPDF() {
            const ticketElement = document.getElementById('eTicket');
            
            if (!ticketElement) {
                alert('‚ö†Ô∏è Tiket belum dimuat!');
                return;
            }

            try {
                // Show loading
                const oldText = event.target.textContent;
                event.target.textContent = '‚è≥ Generating PDF...';
                event.target.disabled = true;

                // Capture tiket sebagai canvas menggunakan html2canvas
                const canvas = await html2canvas(ticketElement, {
                    scale: 2, // Quality tinggi
                    backgroundColor: '#ffffff',
                    logging: false
                });

                // Convert canvas ke image data
                const imgData = canvas.toDataURL('image/png');

                // Buat PDF menggunakan jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Hitung dimensi untuk fit ke A4
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

                // Add image ke PDF
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

                // Download PDF
                const booking = allBookings.find(b => 
                    ticketElement.textContent.includes(b.bookingNumber)
                );
                const filename = `E-Ticket-${booking.bookingNumber}.pdf`;
                pdf.save(filename);

                // Reset button
                event.target.textContent = oldText;
                event.target.disabled = false;

                alert('‚úÖ Tiket berhasil didownload sebagai PDF!');
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('‚ö†Ô∏è Gagal generate PDF. Silakan coba lagi.');
                event.target.textContent = oldText;
                event.target.disabled = false;
            }
        }

        /**
         * DOWNLOAD TICKET AS IMAGE
         * Download tiket dalam format PNG
         */
        async function downloadTicketImage() {
            const ticketElement = document.getElementById('eTicket');
            
            if (!ticketElement) {
                alert('‚ö†Ô∏è Tiket belum dimuat!');
                return;
            }

            try {
                // Show loading
                const oldText = event.target.textContent;
                event.target.textContent = '‚è≥ Generating Image...';
                event.target.disabled = true;

                // Capture tiket sebagai canvas
                const canvas = await html2canvas(ticketElement, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false
                });

                // Convert canvas ke blob
                canvas.toBlob(function(blob) {
                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    // Get booking number untuk filename
                    const booking = allBookings.find(b => 
                        ticketElement.textContent.includes(b.bookingNumber)
                    );
                    
                    link.download = `E-Ticket-${booking.bookingNumber}.png`;
                    link.href = url;
                    link.click();
                    
                    // Cleanup
                    URL.revokeObjectURL(url);

                    // Reset button
                    event.target.textContent = oldText;
                    event.target.disabled = false;

                    alert('‚úÖ Tiket berhasil didownload sebagai Image!');
                });
            } catch (error) {
                console.error('Error generating image:', error);
                alert('‚ö†Ô∏è Gagal generate image. Silakan coba lagi.');
                event.target.textContent = oldText;
                event.target.disabled = false;
            }
        }

        /**
         * CLOSE TICKET MODAL
         * Tutup modal tiket
         */
        function closeTicketModal() {
            document.getElementById('ticketModal').classList.remove('active');
            // Clear QR code
            document.getElementById('qrcode').innerHTML = '';
        }

        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        function getPaymentLabel(method) {
            const labels = {
                'transfer': 'Transfer Bank',
                'ewallet': 'E-Wallet',
                'cc': 'Kartu Kredit'
            };
            return labels[method] || method;
        }

        function getPaymentDetailsHTML(booking) {
            if (!booking.paymentDetails) return '';

            const details = booking.paymentDetails;
            let html = '<div class="payment-details-box">';
            html += '<h5>üí≥ Detail Pembayaran</h5>';

            if (details.method === 'transfer' && details.bank) {
                html += '<div class="detail-grid">';
                html += `<div class="detail-item"><span>Bank Tujuan:</span><strong>${details.bank}</strong></div>`;
                html += `<div class="detail-item"><span>Nama Pengirim:</span><strong>${details.accountName}</strong></div>`;
                html += `<div class="detail-item"><span>No. Rekening:</span><strong>${details.accountNumber}</strong></div>`;
                if (details.uploadedAt) {
                    html += `<div class="detail-item"><span>Waktu Upload:</span><strong>${details.uploadedAt}</strong></div>`;
                }
                if (details.proofImage) {
                    html += `<div class="detail-item" style="grid-column: 1 / -1;">
                        <span>Bukti Transfer:</span>
                        <div class="payment-proof-image">
                            <img src="${details.proofImage}" alt="Bukti Transfer" 
                                 onclick="window.open(this.src, '_blank')" 
                                 style="cursor: pointer; width: 100%; height: auto; display: block;">
                        </div>
                        <small style="color: #78350F; display: block; margin-top: 8px; text-align: center;">üì∏ Klik untuk memperbesar</small>
                    </div>`;
                }
                html += '</div>';
            } else if (details.method === 'ewallet' && details.ewalletType) {
                html += '<div class="detail-grid">';
                html += `<div class="detail-item"><span>E-Wallet:</span><strong>${details.ewalletType}</strong></div>`;
                html += `<div class="detail-item"><span>Nomor:</span><strong>${details.ewalletNumber}</strong></div>`;
                if (details.uploadedAt) {
                    html += `<div class="detail-item"><span>Waktu Upload:</span><strong>${details.uploadedAt}</strong></div>`;
                }
                if (details.proofImage) {
                    html += `<div class="detail-item" style="grid-column: 1 / -1;">
                        <span>Bukti Pembayaran:</span>
                        <div class="payment-proof-image">
                            <img src="${details.proofImage}" alt="Bukti Pembayaran" 
                                 onclick="window.open(this.src, '_blank')" 
                                 style="cursor: pointer; width: 100%; height: auto; display: block;">
                        </div>
                        <small style="color: #78350F; display: block; margin-top: 8px; text-align: center;">üì∏ Klik untuk memperbesar</small>
                    </div>`;
                }
                html += '</div>';
            } else if (details.method === 'cc') {
                html += '<p style="color: #78350F; font-weight: 600;">üí≥ Pembayaran via Kartu Kredit</p>';
            }

            html += '</div>';
            return html;
        }

        function getStatusColor(status) {
            const colors = {
                'Pending': 'linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%)',
                'Lunas': 'linear-gradient(135deg, #34D399 0%, #10B981 100%)',
                'Dibatalkan': 'linear-gradient(135deg, #F87171 0%, #EF4444 100%)'
            };
            return colors[status] || '#999';
        }

        function getStatusIcon(status) {
            const icons = {
                'Pending': 'üü°',
                'Lunas': 'üü¢',
                'Dibatalkan': 'üî¥'
            };
            return icons[status] || '‚ö™';
        }

        // ========================================
        // LOGOUT
        // ========================================
        function handleLogout() {
            if (confirm('Yakin ingin logout?')) {
                localStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        }

        // ========================================
        // INISIALISASI
        // ========================================
        window.onload = function() {
            const user = checkAuth();
            if (user) {
                document.getElementById('userName').textContent = `Halo, ${user.name}! üëã`;
                loadBookings();
            }
        };
    </script>
</body>
</html>